#!/usr/bin/env python3
"""
Dashboard Integrado METGO 3D - Recomendaciones Agr√≠colas Inteligentes
Combina datos meteorol√≥gicos en tiempo real con recomendaciones agr√≠colas avanzadas
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
from datetime import datetime, timedelta
import sqlite3
import json

# Configuraci√≥n de la p√°gina
st.set_page_config(
    page_title="METGO 3D - Dashboard Integrado de Recomendaciones",
    page_icon="üåæ",
    layout="wide",
    initial_sidebar_state="expanded"
)

class DashboardIntegradoRecomendaciones:
    def __init__(self, db_path="datos_meteorologicos.db"):
        self.db_path = db_path
        self.estaciones = ['quillota_centro', 'la_cruz', 'nogueira', 'colliguay', 'hijuelas', 'calera']
        self.cultivos = {
            'paltos': {'nombre': 'Paltos', 'temp_optima': (15, 25), 'humedad_optima': (60, 80)},
            'citricos': {'nombre': 'C√≠tricos', 'temp_optima': (12, 28), 'humedad_optima': (50, 70)},
            'vides': {'nombre': 'Vides', 'temp_optima': (10, 30), 'humedad_optima': (40, 60)},
            'tomates': {'nombre': 'Tomates', 'temp_optima': (18, 25), 'humedad_optima': (60, 80)},
            'lechugas': {'nombre': 'Lechugas', 'temp_optima': (10, 20), 'humedad_optima': (70, 90)}
        }
    
    def obtener_datos_actuales(self):
        """Obtener datos meteorol√≥gicos actuales"""
        try:
            conn = sqlite3.connect(self.db_path)
            query = '''
                SELECT estacion, fecha, temperatura, humedad, presion, precipitacion,
                       velocidad_viento, direccion_viento, nubosidad, indice_uv
                FROM datos_meteorologicos
                WHERE fecha = (
                    SELECT MAX(fecha) 
                    FROM datos_meteorologicos d2 
                    WHERE d2.estacion = datos_meteorologicos.estacion
                )
                ORDER BY estacion
            '''
            df = pd.read_sql_query(query, conn)
            conn.close()
            
            if not df.empty:
                df['fecha'] = pd.to_datetime(df['fecha'], errors='coerce')
            
            return df
        except Exception as e:
            st.error(f"Error obteniendo datos actuales: {e}")
            return pd.DataFrame()
    
    def obtener_datos_historicos(self, dias=7):
        """Obtener datos hist√≥ricos"""
        try:
            conn = sqlite3.connect(self.db_path)
            query = '''
                SELECT estacion, fecha, temperatura, humedad, presion, precipitacion,
                       velocidad_viento, direccion_viento, nubosidad, indice_uv
                FROM datos_meteorologicos
                ORDER BY fecha DESC
                LIMIT ?
            '''
            df = pd.read_sql_query(query, conn, params=[dias * 24 * len(self.estaciones)])
            conn.close()
            
            if not df.empty:
                df['fecha'] = pd.to_datetime(df['fecha'], errors='coerce')
                # Filtrar por los √∫ltimos N d√≠as
                fecha_limite = datetime.now() - timedelta(days=dias)
                df = df[df['fecha'] >= fecha_limite]
            
            return df
        except Exception as e:
            st.error(f"Error obteniendo datos hist√≥ricos: {e}")
            return pd.DataFrame()
    
    def analizar_condiciones_agricolas(self, datos):
        """Analizar condiciones para recomendaciones agr√≠colas"""
        if datos.empty:
            return {}
        
        analisis = {}
        
        # Temperatura promedio
        temp_promedio = datos['temperatura'].mean()
        temp_max = datos['temperatura'].max()
        temp_min = datos['temperatura'].min()
        
        # Humedad promedio
        humedad_promedio = datos['humedad'].mean()
        
        # Precipitaci√≥n total
        precipitacion_total = datos['precipitacion'].sum()
        
        # Viento promedio
        viento_promedio = datos['velocidad_viento'].mean()
        
        analisis = {
            'temperatura': {
                'promedio': temp_promedio,
                'maxima': temp_max,
                'minima': temp_min,
                'variabilidad': temp_max - temp_min
            },
            'humedad': {
                'promedio': humedad_promedio,
                'nivel': 'alta' if humedad_promedio > 70 else 'media' if humedad_promedio > 50 else 'baja'
            },
            'precipitacion': {
                'total': precipitacion_total,
                'dias_lluvia': (datos['precipitacion'] > 0).sum(),
                'intensidad': 'alta' if precipitacion_total > 20 else 'media' if precipitacion_total > 5 else 'baja'
            },
            'viento': {
                'promedio': viento_promedio,
                'nivel': 'fuerte' if viento_promedio > 20 else 'moderado' if viento_promedio > 10 else 'suave'
            }
        }
        
        return analisis
    
    def generar_recomendaciones_riego(self, analisis, cultivo):
        """Generar recomendaciones de riego basadas en condiciones meteorol√≥gicas"""
        recomendaciones = []
        
        temp_promedio = analisis['temperatura']['promedio']
        humedad_promedio = analisis['humedad']['promedio']
        precipitacion_total = analisis['precipitacion']['total']
        viento_promedio = analisis['viento']['promedio']
        
        cultivo_info = self.cultivos.get(cultivo, {})
        temp_optima = cultivo_info.get('temp_optima', (15, 25))
        humedad_optima = cultivo_info.get('humedad_optima', (60, 80))
        
        # Recomendaciones de riego
        if precipitacion_total > 15:
            recomendaciones.append({
                'tipo': 'riego',
                'nivel': 'info',
                'mensaje': 'Precipitaci√≥n abundante detectada. Reducir riego manual.',
                'accion': 'Suspender riego por 2-3 d√≠as'
            })
        elif precipitacion_total < 5 and humedad_promedio < 50:
            recomendaciones.append({
                'tipo': 'riego',
                'nivel': 'warning',
                'mensaje': 'Condiciones secas. Incrementar frecuencia de riego.',
                'accion': 'Aumentar riego en 20-30%'
            })
        
        # Recomendaciones de temperatura
        if temp_promedio < temp_optima[0]:
            recomendaciones.append({
                'tipo': 'temperatura',
                'nivel': 'warning',
                'mensaje': 'Temperatura baja para el cultivo.',
                'accion': 'Considerar protecci√≥n t√©rmica o retrasar siembra'
            })
        elif temp_promedio > temp_optima[1]:
            recomendaciones.append({
                'tipo': 'temperatura',
                'nivel': 'warning',
                'mensaje': 'Temperatura alta. Riesgo de estr√©s t√©rmico.',
                'accion': 'Aumentar riego y sombreado'
            })
        
        # Recomendaciones de humedad
        if humedad_promedio > humedad_optima[1]:
            recomendaciones.append({
                'tipo': 'humedad',
                'nivel': 'warning',
                'mensaje': 'Humedad alta. Riesgo de enfermedades f√∫ngicas.',
                'accion': 'Mejorar ventilaci√≥n y aplicar fungicidas preventivos'
            })
        elif humedad_promedio < humedad_optima[0]:
            recomendaciones.append({
                'tipo': 'humedad',
                'nivel': 'info',
                'mensaje': 'Humedad baja. Considerar riego foliar.',
                'accion': 'Aplicar riego foliar en horas frescas'
            })
        
        return recomendaciones
    
    def generar_alertas_plagas(self, analisis):
        """Generar alertas de plagas basadas en condiciones meteorol√≥gicas"""
        alertas = []
        
        temp_promedio = analisis['temperatura']['promedio']
        humedad_promedio = analisis['humedad']['promedio']
        viento_promedio = analisis['viento']['promedio']
        
        # Alerta de √°fidos (condiciones favorables: temp 20-25¬∞C, humedad 60-80%)
        if 20 <= temp_promedio <= 25 and 60 <= humedad_promedio <= 80:
            alertas.append({
                'plaga': '√Åfidos',
                'nivel': 'warning',
                'mensaje': 'Condiciones favorables para desarrollo de √°fidos',
                'prevencion': 'Aplicar aceite mineral o insecticida sist√©mico'
            })
        
        # Alerta de hongos (alta humedad)
        if humedad_promedio > 75:
            alertas.append({
                'plaga': 'Enfermedades F√∫ngicas',
                'nivel': 'danger',
                'mensaje': 'Alta humedad favorece desarrollo de hongos',
                'prevencion': 'Aplicar fungicida preventivo y mejorar ventilaci√≥n'
            })
        
        # Alerta de √°caros (baja humedad y viento)
        if humedad_promedio < 45 and viento_promedio > 15:
            alertas.append({
                'plaga': '√Åcaros',
                'nivel': 'info',
                'mensaje': 'Condiciones secas y ventosas favorecen √°caros',
                'prevencion': 'Aumentar humedad y aplicar acaricida'
            })
        
        return alertas
    
    def generar_alertas_heladas(self, analisis, pronostico_7_dias=None):
        """Generar alertas de heladas"""
        alertas = []
        
        temp_minima = analisis['temperatura']['minima']
        temp_promedio = analisis['temperatura']['promedio']
        viento_promedio = analisis['viento']['promedio']
        nubosidad_promedio = analisis.get('nubosidad', {}).get('promedio', 50)
        
        # Alerta inmediata de helada
        if temp_minima < 2:
            alertas.append({
                'tipo': 'helada',
                'nivel': 'danger',
                'mensaje': 'Riesgo CR√çTICO de helada detectado',
                'accion': 'Activar sistema de protecci√≥n inmediatamente'
            })
        elif temp_minima < 5:
            alertas.append({
                'tipo': 'helada',
                'nivel': 'warning',
                'mensaje': 'Riesgo de helada moderado',
                'accion': 'Preparar sistemas de protecci√≥n'
            })
        
        # Condiciones favorables para heladas
        if temp_promedio < 10 and viento_promedio < 5 and nubosidad_promedio < 30:
            alertas.append({
                'tipo': 'helada',
                'nivel': 'info',
                'mensaje': 'Condiciones favorables para heladas nocturnas',
                'accion': 'Monitorear temperaturas nocturnas'
            })
        
        return alertas
    
    def crear_grafico_condiciones_agricolas(self, analisis):
        """Crear gr√°fico de condiciones agr√≠colas"""
        fig = make_subplots(
            rows=2, cols=2,
            subplot_titles=('Temperatura', 'Humedad', 'Precipitaci√≥n', 'Viento'),
            specs=[[{"type": "indicator"}, {"type": "indicator"}],
                   [{"type": "indicator"}, {"type": "indicator"}]]
        )
        
        # Temperatura
        fig.add_trace(go.Indicator(
            mode = "gauge+number+delta",
            value = analisis['temperatura']['promedio'],
            domain = {'x': [0, 1], 'y': [0, 1]},
            title = {'text': "Temperatura (¬∞C)"},
            gauge = {
                'axis': {'range': [None, 40]},
                'bar': {'color': "darkblue"},
                'steps': [
                    {'range': [0, 15], 'color': "lightblue"},
                    {'range': [15, 25], 'color': "lightgreen"},
                    {'range': [25, 35], 'color': "yellow"},
                    {'range': [35, 40], 'color': "red"}
                ],
                'threshold': {
                    'line': {'color': "red", 'width': 4},
                    'thickness': 0.75,
                    'value': 30
                }
            }
        ), row=1, col=1)
        
        # Humedad
        fig.add_trace(go.Indicator(
            mode = "gauge+number",
            value = analisis['humedad']['promedio'],
            domain = {'x': [0, 1], 'y': [0, 1]},
            title = {'text': "Humedad (%)"},
            gauge = {
                'axis': {'range': [0, 100]},
                'bar': {'color': "darkgreen"},
                'steps': [
                    {'range': [0, 30], 'color': "lightcoral"},
                    {'range': [30, 60], 'color': "lightyellow"},
                    {'range': [60, 80], 'color': "lightgreen"},
                    {'range': [80, 100], 'color': "lightblue"}
                ]
            }
        ), row=1, col=2)
        
        # Precipitaci√≥n
        fig.add_trace(go.Indicator(
            mode = "number+delta",
            value = analisis['precipitacion']['total'],
            title = {'text': "Precipitaci√≥n (mm)"},
            delta = {'reference': 10}
        ), row=2, col=1)
        
        # Viento
        fig.add_trace(go.Indicator(
            mode = "gauge+number",
            value = analisis['viento']['promedio'],
            domain = {'x': [0, 1], 'y': [0, 1]},
            title = {'text': "Viento (km/h)"},
            gauge = {
                'axis': {'range': [0, 50]},
                'bar': {'color': "darkorange"},
                'steps': [
                    {'range': [0, 10], 'color': "lightgreen"},
                    {'range': [10, 20], 'color': "yellow"},
                    {'range': [20, 35], 'color': "orange"},
                    {'range': [35, 50], 'color': "red"}
                ]
            }
        ), row=2, col=2)
        
        fig.update_layout(
            height=600, 
            title_text="Condiciones Meteorol√≥gicas para Agricultura",
            showlegend=False
        )
        return fig

def main():
    """Funci√≥n principal del dashboard"""
    
    # T√≠tulo principal
    st.title("üåæ METGO 3D - Dashboard Integrado de Recomendaciones Agr√≠colas")
    st.markdown("### Sistema Inteligente de Recomendaciones Meteorol√≥gicas y Agr√≠colas")
    
    # Inicializar dashboard
    dashboard = DashboardIntegradoRecomendaciones()
    
    # Sidebar
    with st.sidebar:
        st.header("‚öôÔ∏è Configuraci√≥n")
        
        # Selector de cultivo
        cultivo = st.selectbox(
            "üå± Seleccionar Cultivo",
            list(dashboard.cultivos.keys()),
            format_func=lambda x: dashboard.cultivos[x]['nombre']
        )
        
        # Selector de per√≠odo
        periodo = st.selectbox(
            "üìÖ Per√≠odo de An√°lisis",
            ["√öltimas 6 horas", "√öltimas 12 horas", "√öltimo d√≠a", "√öltimos 3 d√≠as", "√öltima semana"],
            index=3
        )
        
        # Mapeo de per√≠odos a d√≠as
        dias_map = {
            "√öltimas 6 horas": 0.25,
            "√öltimas 12 horas": 0.5,
            "√öltimo d√≠a": 1,
            "√öltimos 3 d√≠as": 3,
            "√öltima semana": 7
        }
        
        dias = int(dias_map[periodo])
        
        # Bot√≥n de actualizaci√≥n
        if st.button("üîÑ Actualizar An√°lisis"):
            st.rerun()
    
    # Obtener datos
    datos_actuales = dashboard.obtener_datos_actuales()
    datos_historicos = dashboard.obtener_datos_historicos(dias)
    
    if datos_historicos.empty:
        st.warning("‚ö†Ô∏è No hay datos meteorol√≥gicos disponibles para el an√°lisis.")
        return
    
    # Analizar condiciones agr√≠colas
    analisis = dashboard.analizar_condiciones_agricolas(datos_historicos)
    
    if not analisis:
        st.error("‚ùå Error en el an√°lisis de condiciones agr√≠colas.")
        return
    
    # Mostrar gr√°fico de condiciones
    st.subheader("üìä Condiciones Meteorol√≥gicas Actuales")
    fig_condiciones = dashboard.crear_grafico_condiciones_agricolas(analisis)
    st.plotly_chart(fig_condiciones, config=PLOTLY_CONFIG, use_container_width=True)
    
    # Generar recomendaciones
    recomendaciones_riego = dashboard.generar_recomendaciones_riego(analisis, cultivo)
    alertas_plagas = dashboard.generar_alertas_plagas(analisis)
    alertas_heladas = dashboard.generar_alertas_heladas(analisis)
    
    # Mostrar recomendaciones de riego
    st.subheader("üíß Recomendaciones de Riego")
    if recomendaciones_riego:
        for rec in recomendaciones_riego:
            if rec['nivel'] == 'warning':
                st.warning(f"‚ö†Ô∏è {rec['mensaje']}")
                st.info(f"üí° **Acci√≥n recomendada:** {rec['accion']}")
            elif rec['nivel'] == 'info':
                st.info(f"‚ÑπÔ∏è {rec['mensaje']}")
                st.info(f"üí° **Acci√≥n recomendada:** {rec['accion']}")
    else:
        st.success("‚úÖ Condiciones de riego normales para el cultivo seleccionado.")
    
    # Mostrar alertas de plagas
    st.subheader("üêõ Alertas de Plagas y Enfermedades")
    if alertas_plagas:
        for alerta in alertas_plagas:
            if alerta['nivel'] == 'danger':
                st.error(f"üö® **{alerta['plaga']}:** {alerta['mensaje']}")
                st.info(f"üõ°Ô∏è **Prevenci√≥n:** {alerta['prevencion']}")
            elif alerta['nivel'] == 'warning':
                st.warning(f"‚ö†Ô∏è **{alerta['plaga']}:** {alerta['mensaje']}")
                st.info(f"üõ°Ô∏è **Prevenci√≥n:** {alerta['prevencion']}")
            else:
                st.info(f"‚ÑπÔ∏è **{alerta['plaga']}:** {alerta['mensaje']}")
                st.info(f"üõ°Ô∏è **Prevenci√≥n:** {alerta['prevencion']}")
    else:
        st.success("‚úÖ No se detectan condiciones favorables para plagas o enfermedades.")
    
    # Mostrar alertas de heladas
    st.subheader("‚ùÑÔ∏è Alertas de Heladas")
    if alertas_heladas:
        for alerta in alertas_heladas:
            if alerta['nivel'] == 'danger':
                st.error(f"üö® {alerta['mensaje']}")
                st.error(f"üö® **ACCI√ìN INMEDIATA:** {alerta['accion']}")
            elif alerta['nivel'] == 'warning':
                st.warning(f"‚ö†Ô∏è {alerta['mensaje']}")
                st.warning(f"‚ö†Ô∏è **Acci√≥n recomendada:** {alerta['accion']}")
            else:
                st.info(f"‚ÑπÔ∏è {alerta['mensaje']}")
                st.info(f"‚ÑπÔ∏è **Acci√≥n recomendada:** {alerta['accion']}")
    else:
        st.success("‚úÖ No se detectan riesgos de heladas.")
    
    # Resumen ejecutivo
    st.subheader("üìã Resumen Ejecutivo")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "üå°Ô∏è Temperatura",
            f"{analisis['temperatura']['promedio']:.1f}¬∞C",
            f"Rango: {analisis['temperatura']['minima']:.1f}¬∞C - {analisis['temperatura']['maxima']:.1f}¬∞C"
        )
    
    with col2:
        st.metric(
            "üíß Humedad",
            f"{analisis['humedad']['promedio']:.1f}%",
            f"Nivel: {analisis['humedad']['nivel']}"
        )
    
    with col3:
        st.metric(
            "üåßÔ∏è Precipitaci√≥n",
            f"{analisis['precipitacion']['total']:.1f}mm",
            f"D√≠as lluvia: {analisis['precipitacion']['dias_lluvia']}"
        )
    
    with col4:
        st.metric(
            "üí® Viento",
            f"{analisis['viento']['promedio']:.1f} km/h",
            f"Nivel: {analisis['viento']['nivel']}"
        )
    
    # Informaci√≥n del sistema
    with st.expander("‚ÑπÔ∏è Informaci√≥n del Sistema"):
        st.write(f"**Cultivo seleccionado:** {dashboard.cultivos[cultivo]['nombre']}")
        st.write(f"**Per√≠odo analizado:** {periodo}")
        st.write(f"**√öltima actualizaci√≥n:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        st.write(f"**Total de alertas:** {len(recomendaciones_riego) + len(alertas_plagas) + len(alertas_heladas)}")
        
        # Condiciones √≥ptimas del cultivo
        cultivo_info = dashboard.cultivos[cultivo]
        st.write(f"**Temperatura √≥ptima:** {cultivo_info['temp_optima'][0]}¬∞C - {cultivo_info['temp_optima'][1]}¬∞C")
        st.write(f"**Humedad √≥ptima:** {cultivo_info['humedad_optima'][0]}% - {cultivo_info['humedad_optima'][1]}%")

if __name__ == "__main__":
    main()
